const o={context:void 0,registry:void 0};function d(t){o.context=t}function _(){return{...o.context,id:`${o.context.id}${o.context.count++}-`,count:0}}const q=(t,e)=>t===e,m={equals:q};let M=z;const p=1,A=2,V={owned:null,cleanups:null,context:null,owner:null};var l=null;let P=null,tt=null,i=null,c=null,a=null,$=0;function et(t,e){const s=i,n=l,r=t.length===0,u=e===void 0?n:e,f=r?V:{owned:null,cleanups:null,context:u?u.context:null,owner:u},N=r?t:()=>t(()=>g(()=>U(f)));l=f,i=null;try{return C(N,!0)}finally{i=s,l=n}}function R(t,e){e=e?Object.assign({},m,e):m;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),W(s,r));return[Q.bind(s),n]}function nt(t,e,s){const n=j(t,e,!1,p);S(n)}function st(t,e,s){M=at;const n=j(t,e,!1,p),r=E&&I(E);r&&(n.suspense=r),n.user=!0,a?a.push(n):S(n)}function y(t,e,s){s=s?Object.assign({},m,s):m;const n=j(t,e,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,S(n),Q.bind(n)}function g(t){if(i===null)return t();const e=i;i=null;try{return t()}finally{i=e}}function gt(t){st(()=>g(t))}function rt(t){return l===null||(l.cleanups===null?l.cleanups=[t]:l.cleanups.push(t)),t}function ut(){return l}function lt(t){a.push.apply(a,t),t.length=0}function G(t,e){const s=Symbol("context");return{id:s,Provider:ht(s),defaultValue:t}}function I(t){return l&&l.context&&l.context[t.id]!==void 0?l.context[t.id]:t.defaultValue}function ot(t){const e=y(t),s=y(()=>T(e()));return s.toArray=()=>{const n=s();return Array.isArray(n)?n:n!=null?[n]:[]},s}let E;function it(){return E||(E=G())}function Q(){if(this.sources&&this.state)if(this.state===p)S(this);else{const t=c;c=null,C(()=>F(this),!1),c=t}if(i){const t=this.observers?this.observers.length:0;i.sources?(i.sources.push(this),i.sourceSlots.push(t)):(i.sources=[this],i.sourceSlots=[t]),this.observers?(this.observers.push(i),this.observerSlots.push(i.sources.length-1)):(this.observers=[i],this.observerSlots=[i.sources.length-1])}return this.value}function W(t,e,s){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&C(()=>{for(let r=0;r<t.observers.length;r+=1){const u=t.observers[r],f=P&&P.running;f&&P.disposed.has(u),(f?!u.tState:!u.state)&&(u.pure?c.push(u):a.push(u),u.observers&&B(u)),f||(u.state=p)}if(c.length>1e6)throw c=[],new Error},!1)),e}function S(t){if(!t.fn)return;U(t);const e=$;ct(t,t.value,e)}function ct(t,e,s){let n;const r=l,u=i;i=l=t;try{n=t.fn(e)}catch(f){return t.pure&&(t.state=p,t.owned&&t.owned.forEach(U),t.owned=null),t.updatedAt=s+1,J(f)}finally{i=u,l=r}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?W(t,n):t.value=n,t.updatedAt=s)}function j(t,e,s,n=p,r){const u={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:l,context:l?l.context:null,pure:s};return l===null||l!==V&&(l.owned?l.owned.push(u):l.owned=[u]),u}function k(t){if(t.state===0)return;if(t.state===A)return F(t);if(t.suspense&&g(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<$);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===p)S(t);else if(t.state===A){const n=c;c=null,C(()=>F(t,e[0]),!1),c=n}}function C(t,e){if(c)return t();let s=!1;e||(c=[]),a?s=!0:a=[],$++;try{const n=t();return ft(s),n}catch(n){s||(a=null),c=null,J(n)}}function ft(t){if(c&&(z(c),c=null),t)return;const e=a;a=null,e.length&&C(()=>M(e),!1)}function z(t){for(let e=0;e<t.length;e++)k(t[e])}function at(t){let e,s=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[s++]=n:k(n)}if(o.context){if(o.count){o.effects||(o.effects=[]),o.effects.push(...t.slice(0,s));return}else o.effects&&(t=[...o.effects,...t],s+=o.effects.length,delete o.effects);d()}for(e=0;e<s;e++)k(t[e])}function F(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const n=t.sources[s];if(n.sources){const r=n.state;r===p?n!==e&&(!n.updatedAt||n.updatedAt<$)&&k(n):r===A&&F(n,e)}}}function B(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=A,s.pure?c.push(s):a.push(s),s.observers&&B(s))}}function U(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),n=t.sourceSlots.pop(),r=s.observers;if(r&&r.length){const u=r.pop(),f=s.observerSlots.pop();n<r.length&&(u.sourceSlots[f]=n,r[n]=u,s.observerSlots[n]=f)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)U(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function pt(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function J(t,e=l){throw pt(t)}function T(t){if(typeof t=="function"&&!t.length)return T(t());if(Array.isArray(t)){const e=[];for(let s=0;s<t.length;s++){const n=T(t[s]);Array.isArray(n)?e.push.apply(e,n):e.push(n)}return e}return t}function ht(t,e){return function(n){let r;return nt(()=>r=g(()=>(l.context={...l.context,[t]:n.value},ot(()=>n.children))),void 0),r}}let K=!1;function wt(){K=!0}function dt(t,e){if(K&&o.context){const s=o.context;d(_());const n=g(()=>t(e||{}));return d(s),n}return g(()=>t(e||{}))}const bt=G();function xt(t){let e=0,s,n,r,u,f;const[N,D]=R(!1),X=it(),w={increment:()=>{++e===1&&D(!0)},decrement:()=>{--e===0&&D(!1)},inFallback:N,effects:[],resolved:!1},Y=ut();if(o.context&&o.load){const x=o.context.id+o.context.count;let b=o.load(x);if(b&&(typeof b!="object"||b.status!=="success"?r=b:o.gather(x)),r&&r!=="$$f"){const[O,v]=R(void 0,{equals:!1});u=O,r.then(()=>{if(o.done)return v();o.gather(x),d(n),v(),d()},L=>{f=L,v()})}}const H=I(bt);H&&(s=H.register(w.inFallback));let h;return rt(()=>h&&h()),dt(X.Provider,{value:w,get children(){return y(()=>{if(f)throw f;if(n=o.context,u)return u(),u=void 0;n&&r==="$$f"&&d();const x=y(()=>t.children);return y(b=>{const O=w.inFallback(),{showContent:v=!0,showFallback:L=!0}=s?s():{};if((!O||r&&r!=="$$f")&&v)return w.resolved=!0,h&&h(),h=n=r=void 0,lt(w.effects),x();if(L)return h?b:et(Z=>(h=Z,n&&(d({id:n.id+"f",count:0}),n=void 0),t.fallback),Y)})})}})}export{xt as S,et as a,nt as b,dt as c,rt as d,wt as e,gt as o,o as s,g as u};
